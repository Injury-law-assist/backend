name: Node.js CI

on:
    push:
        branches:
            - '*'
            - 'feat/chat'
            - 'feat/auth'

jobs:
    ci-workflows:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20' # 최신 권장 버전인 Node.js 20 사용

            - name: Install dependencies
              run: npm ci # npm ci를 사용하여 패키지를 더 빠르게 설치

            - name: Run tests
              env:
                  DB_HOST: ${{ secrets.DB_HOST }}
                  DB_USER: ${{ secrets.DB_USER }}
                  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
                  DB_DATABASE: ${{ secrets.DB_DATABASE }}
                  DB_CONNECTION_LIMIT: ${{ secrets.DB_CONNECTION_LIMIT }}
              run: npm test

            - name: Save coverage report
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/coverage-report.html

            - name: Format code with Prettier
              run: npm run format

            - name: Check for formatting changes
              run: git diff --exit-code || exit 1 # 포맷팅 변경 사항이 있을 경우 CI 실패로 처리
